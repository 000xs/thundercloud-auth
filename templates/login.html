<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Storm Kingdom Login</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>
  <body>
    <div class="emoji-background"></div>
    <div class="container">
      <form action="/auth/login" method="POST" id="login-form">
        <h1>ğŸŒ©ï¸ Storm Kingdom Login</h1>

        <!-- Username -->
        <div class="form-section">
          <h2>ğŸ‘‘ Kingdom Name</h2>
          <div class="in-item">
            <label for="username">Kingdom Name</label>
            <input
              placeholder="Enter your storm master name"
              type="text"
              id="username"
              name="username"
              required
            />
          </div>
        </div>

        <!-- Password as emoji drag-drop -->
        <div class="form-section">
          <h2>ğŸ” Your Storm Sequence Password</h2>
          <p>Drag 5â€“7 weather emojis to enter your password</p>

          <div class="drop-zone" id="storm-password-drop">
            Drop your storm elements here...
          </div>
          <p id="password-sequence-count">Sequence: 0/7 elements</p>

          <!-- Weather Elements to drag -->
          <div class="weather-elements">
            <span>â˜ï¸</span>
            <span>ğŸŒ¥ï¸</span>
            <span>â›…</span>
            <span>ğŸŒ©ï¸</span>
            <span>ğŸŒ§ï¸</span>
            <span>ğŸŒ¦ï¸</span>
            <span>ğŸŒªï¸</span>
            <span>ğŸŒ¨ï¸</span>
            <span>â˜€ï¸</span>
          </div>

          <!-- Hidden input to submit the sequence -->
          <input type="hidden" name="password" id="password_input" required />
        </div>

        <input
          type="submit"
          value="âš¡ Enter Your Storm Kingdom"
          class="cta-btn"
        />
      </form>
    </div>

    <script>
      const emojiMap = {
        "â˜ï¸": ":cloud:",
        "ğŸŒ¥ï¸": ":sun_behind_large_cloud:",
        "â›…": ":sun_behind_cloud:",
        "ğŸŒ©ï¸": ":cloud_with_lightning:",
        "ğŸŒ§ï¸": ":cloud_with_rain:",
        "ğŸŒ¦ï¸": ":sun_behind_rain_cloud:",
        "ğŸŒªï¸": ":tornado:",
        "ğŸŒ¨ï¸": ":cloud_with_snow:",
        "â˜€ï¸": ":sun:",
      };

      const weatherElements = document.querySelectorAll(
        ".weather-elements span"
      );
      const dropZone = document.getElementById("storm-password-drop");
      const countDisplay = document.getElementById("password-sequence-count");
      const passwordInput = document.getElementById("password_input");
      const form = document.getElementById("login-form");

      let draggedEmoji = null;

      // Touch event handlers for emojis
      weatherElements.forEach((el) => {
        el.addEventListener("touchstart", (e) => {
          draggedEmoji = e.target.textContent;
          e.target.style.opacity = '0.5'; // Visual feedback for dragging
        });

        el.addEventListener("touchmove", (e) => {
          e.preventDefault(); // Prevent scrolling while dragging
        });

        el.addEventListener("touchend", (e) => {
          e.target.style.opacity = '1'; // Reset opacity
          // Simulate drop event on dropZone if touch is within its bounds
          const touch = e.changedTouches[0];
          const dropZoneRect = dropZone.getBoundingClientRect();
          if (
            touch.clientX >= dropZoneRect.left &&
            touch.clientX <= dropZoneRect.right &&
            touch.clientY >= dropZoneRect.top &&
            touch.clientY <= dropZoneRect.bottom
          ) {
            handleDrop(draggedEmoji);
          }
          draggedEmoji = null;
        });

        // Keep dragstart for desktop compatibility
        el.setAttribute("draggable", true);
        el.addEventListener("dragstart", (e) => {
          draggedEmoji = e.target.textContent;
          e.dataTransfer.setData("text", draggedEmoji);
          e.target.style.opacity = '0.5';
        });
        el.addEventListener("dragend", (e) => {
          e.target.style.opacity = '1';
          draggedEmoji = null;
        });
      });

      // Touch event handlers for drop zone
      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
      });

      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        handleDrop(e.dataTransfer.getData("text"));
      });

      dropZone.addEventListener("touchmove", (e) => {
        e.preventDefault(); // Prevent scrolling while hovering over drop zone
      });

      dropZone.addEventListener("touchend", (e) => {
        e.preventDefault();
        if (draggedEmoji) {
          handleDrop(draggedEmoji);
        }
      });

      function handleDrop(emoji) {
        if (dropZone.textContent.includes("Drop your storm elements")) {
          dropZone.textContent = "";
        }
        dropZone.textContent += emoji + " ";
        const count = dropZone.textContent.trim().split(/\s+/).length;
        countDisplay.textContent = `Sequence: ${count}/7 elements`;
      }

      form.addEventListener("submit", (e) => {
        const rawEmojis = dropZone.textContent.trim().split(/\s+/);
        if (rawEmojis.length < 5) {
          e.preventDefault();
          alert(
            "Please drag at least 5 emojis as your storm sequence password."
          );
          return;
        }
        const convertedSequence = rawEmojis
          .map((emj) => emojiMap[emj] || emj)
          .join("");
        passwordInput.value = convertedSequence;
        // form submits normally
      });

      const emojis = ["ğŸŒ©ï¸", "ğŸŒ§ï¸", "ğŸŒªï¸", "ğŸŒ¨ï¸", "â˜€ï¸", "â˜ï¸", "ğŸŒ¥ï¸", "â›…", "ğŸŒ¦ï¸"];
      const background = document.querySelector(".emoji-background");
      for (let i = 0; i < 30; i++) {
        const emoji = document.createElement("div");
        emoji.classList.add("emoji");
        emoji.innerText = emojis[Math.floor(Math.random() * emojis.length)];
        emoji.style.left = Math.random() * 100 + "vw";
        emoji.style.top = Math.random() * 100 + "vh";
        emoji.style.animationDuration = Math.random() * 5 + 5 + "s";
        background.appendChild(emoji);
      }
    </script>
  </body>
</html>
